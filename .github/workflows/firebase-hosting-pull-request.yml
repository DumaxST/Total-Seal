# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Preview Channel
'on': 
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
jobs:
  build_and_deploy_to_preview_channel:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    environment: development 

    steps:

      - name: Extract JIRA Issue ID
        id: jira_issue_id
        run: |
          FULL_STRING="${{ github.head_ref }}"
          JIRAISSUEID=$(echo $FULL_STRING | cut -d'-' -f1,2)
          echo "JIRAISSUEID=$JIRAISSUEID" >> $GITHUB_ENV
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ vars.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build
        env:
          CI: false
          # API URL: Aqui va el API URL del ambiente correspondiente
          # FIREBASE_CONFIG_FILE: vars.FIREBASE_CONFIG_FILE

      - uses: FirebaseExtended/action-hosting-deploy@v0
        id: firebase-deploy
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_DUMAX_TOTAL_SEAL_DEVELOPMENT }}"
          expires: 3d
          # target: development
          projectId: dumax-total-seal-development


      - name: Add comment to JIRA issue
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "body": {
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "text": "Preview Branch Channel: ${{steps.firebase-deploy.outputs.details_url}}/login/lqdU1ErwDswdjSTiVEWp \n Expire in 3 days: ${{steps.firebase-deploy.outputs.expire_time}}",
                        "type": "text"
                      }
                    ]
                  }
                ]
              }
            }' \
            -u ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} \
            ${{vars.JIRA_BASE_URL}}/rest/api/3/issue/$JIRAISSUEID/comment
